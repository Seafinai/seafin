name: Alert on Failures

on:
  workflow_run:
    workflows:
      - "PR Tests & Validation"
      - "Weekly Security Scan & Auto-Update"
    types:
      - completed

  # Also trigger on failed deployments
  deployment_status:

jobs:
  notify-on-failure:
    name: Send Failure Alerts
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' || github.event.deployment_status.state == 'failure' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get failure details
        id: details
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            WORKFLOW_NAME="${{ github.event.workflow_run.name }}"
            WORKFLOW_URL="${{ github.event.workflow_run.html_url }}"
            FAILURE_TYPE="Workflow Failure"
          else
            WORKFLOW_NAME="Deployment"
            WORKFLOW_URL="${{ github.event.deployment_status.target_url }}"
            FAILURE_TYPE="Deployment Failure"
          fi

          echo "workflow_name=$WORKFLOW_NAME" >> $GITHUB_OUTPUT
          echo "workflow_url=$WORKFLOW_URL" >> $GITHUB_OUTPUT
          echo "failure_type=$FAILURE_TYPE" >> $GITHUB_OUTPUT

      - name: Create GitHub Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const workflowName = '${{ steps.details.outputs.workflow_name }}';
            const workflowUrl = '${{ steps.details.outputs.workflow_url }}';
            const failureType = '${{ steps.details.outputs.failure_type }}';

            const title = `ğŸš¨ ${failureType}: ${workflowName}`;
            const body = `## ğŸš¨ Automated Alert: ${failureType}

            **Workflow:** ${workflowName}
            **Status:** âŒ Failed
            **Time:** ${new Date().toISOString()}
            **Triggered by:** ${context.actor}

            ### ğŸ” Details

            [View failed workflow run â†’](${workflowUrl})

            ### ğŸ“‹ What to Do

            1. **Review the failure logs** using the link above
            2. **Check if this is a real issue** or a flaky test
            3. **Fix the issue** if it's a real problem
            4. **Close this issue** once resolved

            ### ğŸ”§ Common Causes

            - **Security vulnerabilities found** - Review and update dependencies
            - **Test failures** - Check syntax errors or breaking changes
            - **Deployment issues** - Check Vercel dashboard and logs
            - **Dependency conflicts** - Review package-lock.json changes

            ---

            **This issue was automatically created by the failure notification system.**
            `;

            // Create issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['automated-alert', 'bug', 'needs-triage']
            });

      - name: Comment on PR if applicable
        if: github.event.workflow_run.pull_requests[0] != null
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ github.event.workflow_run.pull_requests[0].number }};
            const workflowUrl = '${{ steps.details.outputs.workflow_url }}';

            const body = `## ğŸš¨ Tests Failed!

            This PR has failing tests that need to be fixed before merging.

            **What failed:** ${{ steps.details.outputs.workflow_name }}

            [View failure details â†’](${workflowUrl})

            ### ğŸ”§ Next Steps

            1. Review the test failures in the link above
            2. Fix the issues locally
            3. Push new commits to update this PR
            4. Tests will re-run automatically

            ---
            **âš ï¸ Do not merge this PR until all tests pass!**
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: body
            });

  security-vulnerability-alert:
    name: Security Vulnerability Alert
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.name == 'Weekly Security Scan & Auto-Update' && github.event.workflow_run.conclusion == 'failure' }}

    steps:
      - name: Create High-Priority Security Issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'ğŸ”’ SECURITY ALERT: Vulnerabilities Detected';
            const body = `## ğŸ”’ High-Priority Security Alert

            The weekly security scan has detected vulnerabilities in your dependencies.

            ### ğŸš¨ Action Required

            1. **Review the security scan results** [here](${{ github.event.workflow_run.html_url }})
            2. **Update vulnerable packages** using \`npm audit fix\`
            3. **Test the updates** locally before deploying
            4. **Merge the security PR** if one was created

            ### âš¡ Quick Fix

            \`\`\`bash
            # Run security fix
            npm run security:fix

            # Test locally
            ./scripts/test-locally.sh

            # Commit and push if tests pass
            git add package-lock.json
            git commit -m "fix(security): update vulnerable dependencies"
            git push origin main
            \`\`\`

            ### ğŸ“Š Scan Details

            **Scan Date:** ${new Date().toISOString()}
            **Workflow Run:** [View â†’](${{ github.event.workflow_run.html_url }})

            ---

            **âš ï¸ This is a high-priority security issue. Please address it ASAP.**
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'high-priority', 'automated-alert']
            });
