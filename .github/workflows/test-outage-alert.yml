name: Test Outage Alert System

on:
  workflow_dispatch:
    inputs:
      simulate_failure:
        description: 'Simulate website failure'
        required: true
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  test-outage-detection:
    name: Simulate Website Outage
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check website status (simulated outage)
        id: check
        run: |
          if [ "${{ github.event.inputs.simulate_failure }}" = "true" ]; then
            # Simulate outage by checking a non-existent URL
            echo "ðŸ”´ SIMULATING OUTAGE - Testing alert system"
            HTTP_CODE="503"  # Simulate service unavailable
            echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Simulated outage detected (HTTP $HTTP_CODE)"
          else
            # Real check
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" https://seafin.vercel.app/ || echo "000")
            echo "http_code=$HTTP_CODE" >> $GITHUB_OUTPUT

            if [ "$HTTP_CODE" = "200" ]; then
              echo "status=success" >> $GITHUB_OUTPUT
              echo "âœ… Website is accessible (HTTP $HTTP_CODE)"
            else
              echo "status=failure" >> $GITHUB_OUTPUT
              echo "âŒ Website is NOT accessible (HTTP $HTTP_CODE)"
            fi
          fi

      - name: Create test outage alert
        if: steps.check.outputs.status == 'failure'
        uses: actions/github-script@v8
        with:
          script: |
            const httpCode = '${{ steps.check.outputs.http_code }}';
            const isSimulated = '${{ github.event.inputs.simulate_failure }}' === 'true';

            const title = isSimulated
              ? 'ðŸ§ª TEST ALERT: Simulated Website Outage'
              : 'ðŸš¨ CRITICAL: Website Down!';

            const simulatedBanner = isSimulated ? `
            > **âš ï¸ THIS IS A TEST ALERT**
            > This alert was generated by a simulated outage to test the monitoring system.
            > Your actual website is functioning normally.

            ---

            ` : '';

            const body = `${simulatedBanner}## ðŸš¨ Critical Alert: Website is Down

            **Status:** âŒ Not accessible
            **HTTP Code:** ${httpCode}
            **URL:** https://seafin.vercel.app/
            **Detected:** ${new Date().toISOString()}
            **Test Mode:** ${isSimulated ? 'YES - Simulated failure' : 'NO - Real failure'}

            ### ðŸ” Immediate Actions

            1. **Check Vercel Dashboard:** https://vercel.com/seafinai/seafin
            2. **View deployment logs** for errors
            3. **Check recent commits** for breaking changes
            4. **Rollback if necessary** using Vercel dashboard

            ### ðŸ”§ Quick Checks

            \`\`\`bash
            # Check if website is actually down
            curl -I https://seafin.vercel.app/

            # Check recent deployments
            gh run list --limit 5

            # View latest commit
            git log -1

            # Check Vercel deployment status
            # Go to: https://vercel.com/seafinai/seafin/deployments
            \`\`\`

            ### ðŸ“Š Error Details

            **HTTP Status:** ${httpCode}
            ${httpCode === '000' ? '- Network error or DNS issue' : ''}
            ${httpCode === '404' ? '- Page not found' : ''}
            ${httpCode === '500' ? '- Server error' : ''}
            ${httpCode === '502' || httpCode === '503' ? '- Service unavailable (simulated)' : ''}

            ### âœ… How to Resolve

            ${isSimulated ? `
            **Since this is a test:**
            1. Verify you received this alert (you did! âœ…)
            2. Check your email for the notification
            3. Close this issue to mark the test complete
            4. The real monitoring system is working correctly
            ` : `
            **Real outage detected:**
            1. Investigate the issue immediately
            2. Check Vercel logs for errors
            3. Review recent code changes
            4. Rollback or hotfix as needed
            5. Close this issue once resolved
            `}

            ---

            ${isSimulated
              ? '**ðŸ§ª This was a test of the automated alert system. The test was successful!**'
              : '**âš ï¸ CRITICAL: Your production website is down. Immediate action required!**'
            }
            `;

            // Create issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: isSimulated
                ? ['test-alert', 'automated-alert', 'monitoring']
                : ['critical', 'production-down', 'automated-alert']
            });

            console.log(`Created issue #${issue.data.number}: ${issue.data.html_url}`);
            core.setOutput('issue_number', issue.data.number);
            core.setOutput('issue_url', issue.data.html_url);

      - name: Post summary
        run: |
          echo "## ðŸ§ª Outage Alert Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Mode:** ${{ github.event.inputs.simulate_failure }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** ${{ steps.check.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "**HTTP Code:** ${{ steps.check.outputs.http_code }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.check.outputs.status }}" = "failure" ]; then
            echo "âœ… **Alert triggered successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check your:" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub Issues for the alert" >> $GITHUB_STEP_SUMMARY
            echo "- Email for notification" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub notifications" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No alert needed - website is operational**" >> $GITHUB_STEP_SUMMARY
          fi
